# 実装計画

## 実装タスク一覧

- [ ] 1. MCPサーバー基盤の構築
  - 完了条件: 要件1.1〜1.4のインバウンド処理がすべてテストで確認され、サポート外メソッドがUnimplementedで応答される。
  - テストカバレッジ: JSONRPC入出力の統合テスト、メソッドディスパッチのユニットテスト。

- [x] 1.1 MCPプロトコル処理の実装
  - 実装: stdio経由でJSONRPCメッセージを受信・検証し、バリデート済みリクエストをハンドラに委譲するパイプラインを構築。
  - テストファースト: 要件1.1/1.2を満たすため、正常系(有効JSONRPC)・無効JSON・メソッド未指定のケースを先に統合テスト化。
  - 完了条件: 正常リクエストでレスポンスが返る、無効メッセージでInvalidRequest(-32600)が返る、ログに入力/出力が記録される。

- [x] 1.2 MCPメソッドハンドラの登録
  - 実装: create_environment/run_commandをディスパッチャに登録し、未実装メソッドにはUnimplementedを返すルーティングを整備。
  - テストファースト: 要件1.3/1.4に合わせ、存在メソッドの呼び出し成功・未知メソッドでUnimplementedを返す統合テストを用意。
  - 完了条件: ハンドラマップのユニットテストが通過し、統合テストでメソッド分岐が確認できる。

- [ ] 2. 環境管理システムの実装
  - 完了条件: 要件2.*および4.1のデータ保持要件が達成され、環境IDの重複や状態追跡がテストで検証済み。
  - テストカバレッジ: Registry CRUDユニットテスト、並行アクセス検証テスト。

- [ ] 2.1 環境ハンドル構造の実装
  - 実装: EnvironmentHandleにenv_id/container_id/project_root/mount_path/created_at/statusを保持。
  - テストファースト: 要件2.1/2.6に基づき、ハンドル生成時のフィールド初期化とシリアライズ確認のユニットテストを先に作成。
  - 完了条件: ハンドル生成ユニットテストが緑で、create_environmentレスポンス(JSONSnapshot)が期待値に一致。

- [ ] 2.2 環境レジストリの実装
  - 実装: tokio::sync::RwLock<HashMap>を用いた登録・検索・削除、重複チェック、一覧取得の提供。
  - テストファースト: 要件2.4/4.1より、重複登録禁止・未登録IDのエラー・並行読取のユニットテストを先に実装。
  - 完了条件: CRUDユニットテスト、並列アクセステスト（Tokioテスト）が緑、ベンチマーク的にLock競合がログに記録される。

- [ ] 3. Podmanクライアントの実装
  - 完了条件: 要件5.1/6.*を満たす接続/イメージ/コンテナ操作が自動テスト・手動テストで検証済み。
  - テストカバレッジ: 接続前提の自己診断テスト、モックを使ったAPI呼び出しユニットテスト、E2Eでの実行確認。

- [ ] 3.1 Podman事前チェックとフェイルセーフ
  - 実装: 利用OSごとのPodmanソケット/サービス検出、バージョン取得、起動ガイドを含む自己診断APIを用意。
  - テストファースト: 要件5.1/6.1に合わせ、Podman未起動時にInternalError(-32603)と起動手順がログ出力される統合テストを先に作成（サービスをモック化）。
  - 完了条件: 診断ユニットテスト・統合テストで、起動済/未起動双方の挙動が確認できる。

- [ ] 3.2 Podman API接続の確立
  - 実装: bollardでの接続確立、Windows serviceモードとUnixソケットモードの切替、詳細エラーメッセージ出力。
  - テストファースト: 要件6.1/6.4を満たすため、接続成功・資格情報不足・ソケット未存在を想定したモックテストを先に用意。
  - 完了条件: 接続モックテストが成功し、実機手動テストで``create_environment``前の接続検証が通る。

- [ ] 3.3 コンテナイメージ管理
  - 実装: ローカルイメージ確認、レジストリからのプル、進捗ストリーミング、エラーハンドリング。
  - テストファースト: 要件2.2に基づき、ローカル存在・プル成功・プル失敗(RateLimit)のモックテストをRed→Green。
  - 完了条件: 進捗イベントのユニットテストと手動でのプル確認が完了。

- [ ] 3.4 コンテナライフサイクル管理
  - 実装: コンテナ作成設定、バインドマウント、環境変数設定、起動/停止/削除を提供。
  - テストファースト: 要件2.3/2.5/4.2に沿って、起動成功・マウント失敗・停止/削除をモック+一部手動テストから開始。
  - 完了条件: ライフサイクルユニットテスト（bollardモック）が通過し、E2Eで環境作成〜削除が成功。

- [ ] 4. 環境作成機能の実装
  - 完了条件: 要件2.*、4.*の受入条件が`create_environment`統合テストで確認済み。
  - テストカバレッジ: リクエスト検証ユニットテスト、統合テスト(成功/重複ID/イメージ不足/マウント失敗)。

- [ ] 4.1 create_environmentハンドラの実装
  - 実装: request検証、重複チェック、イメージ準備、コンテナ作成、レジストリ登録を一連で行う。
  - テストファースト: 要件2.1/2.4/2.6より、正常系・重複ID・無効パラメータ・イメージ未存在テストを先に追加。
  - 完了条件: 統合テストで上記ケースが通り、ログ/トレースに環境IDが記録される。

- [ ] 4.2 バインドマウントの設定
  - 実装: プロジェクトルート検証、/workdirマウント、Windowsパス変換、詳細エラー出力。
  - テストファースト: 要件2.3/6.2に沿い、存在パス/不存在パス/権限不足/Windowsパスのユニットテストを先行実装。
  - 完了条件: モックテストが緑で、手動E2Eでもマウント成功・失敗双方を確認。

- [ ] 4.3 環境作成レスポンスの生成
  - 実装: 環境ハンドル情報収集、成功レスポンス構築、イベントログ記録。
  - テストファースト: 要件2.6/5.3より、レスポンスJSONスナップショット、ログ出力検証テストを先に用意。
  - 完了条件: 統合テストでレスポンス一致・ログが出力されることを確認。

- [ ] 4.4 Windows環境固有の処理
  - 実装: core.autocrlf、.gitattributes、Job Object準備、Windowsパスエラーのハンドリング。
  - テストファースト: 要件6.2/6.3に基づき、Windowsモックテスト(パス変換/CRLF設定)と手動検証(実機Podman)を先に計画。
  - 完了条件: Windows向けユニットテストと手動検証結果が記録される。

- [ ] 5. コマンド実行機能の実装
  - 完了条件: 要件3.*と5.*を満たすexec処理が統合テスト・E2Eで確認済み。
  - テストカバレッジ: run_command統合テスト、リングバッファユニットテスト、タイムアウトテスト。

- [ ] 5.1 run_commandハンドラの実装
  - 実装: env_id解決、コマンド/タイムアウト検証、追加環境変数適用、存在しない環境のエラーハンドリング。
  - テストファースト: 要件3.1/3.5/3.6より、正常系・未登録ID・無効パラメータ・追加env反映のテストを先に追加。
  - 完了条件: 統合テストで上記ケースが緑、レジストリとの連携ログが確認できる。

- [ ] 5.2 コマンド実行とストリーミング処理
  - 実装: Podman exec起動、stdout/stderr非同期ストリーミング、リアルタイム出力キャプチャ、実行時間計測。
  - テストファースト: 要件3.1/3.2に沿い、短時間コマンド/大量出力/エラー終了のテストを先に実装（大量出力はリングバッファモック）。
  - 完了条件: ストリーミングユニットテストと実環境での`echo hello`確認が通る。

- [ ] 5.3 リングバッファによる出力管理
  - 実装: 64KBリングバッファ、stdout/stderr個別保持、古い出力破棄、テール取得。
  - テストファースト: 要件3.2/4.4/5.4に基づき、オーバーフロー・テール取得・クリア動作のユニットテストを先に作成。
  - 完了条件: ユニットテスト緑、長時間実行手動検証で上限が機能。

- [ ] 5.4 タイムアウト処理の実装
  - 実装: デフォルト120秒、tokio::time::timeout監視、タイムアウト時強制終了、状態記録。
  - テストファースト: 要件3.3/3.7/4.3より、タイムアウト発生・延長設定・即時完了のテストを先に追加。
  - 完了条件: timeoutユニット/統合テスト緑、`sleep 300`手動検証でタイムアウト応答を確認。

- [ ] 5.5 コマンド実行結果の返却
  - 実装: exit code収集、stdout/stderrテール取得、実行時間・タイムアウト情報整形、レスポンス送信。
  - テストファースト: 要件3.4/5.3に従い、成功/失敗/タイムアウトのレスポンススナップショットテストを先行。
  - 完了条件: 統合テストでレスポンス一致、ログに完了イベントが記録。

- [ ] 6. エラーハンドリングとログ管理
  - 完了条件: 要件5.*が満たされ、エラー/ログの粒度がテストで担保される。
  - テストカバレッジ: エラー変換ユニットテスト、ログ出力の統合テスト。

- [ ] 6.1 エラー変換システムの実装
  - 実装: anyhow→MCPエラーコード変換、ユーザー/システムエラー分類、詳細メッセージ/ヒント生成。
  - テストファースト: 要件5.2より、各エラー種別のマッピング、ヒント付与をユニットテストで先に網羅。
  - 完了条件: マッピングテスト緑、実行時ログでヒントが確認できる。

- [ ] 6.2 ログシステムの構築
  - 実装: tracing初期化、環境操作イベントの構造化ログ、exec開始/終了ログ、エラー時の詳細ログ。
  - テストファースト: 要件5.3/5.4に従い、ログ捕捉用テストハーネスでイベントが記録されることを先に検証。
  - 完了条件: ログ検証テスト緑、E2Eログに必要イベントが整列。

- [ ] 6.3 並行アクセスとリトライポリシー
  - 実装: RwLock取得順序の整理、デッドロック監視、並行リクエスト処理、競合時のリトライ戦略。
  - テストファースト: 要件4.1/5.5に沿い、高並列シナリオをシミュレートする統合テスト・プロパティテストを先に実装。
  - 完了条件: 並列統合テスト緑、デッドロック検知ログが無いことを確認。

- [ ] 7. シャットダウンとクリーンアップ
  - 完了条件: 要件4.2/4.3が満たされ、シグナル時に環境・実行中コマンドが安全に終了する。
  - テストカバレッジ: シグナルハンドラユニットテスト、クリーンアップ統合テスト、手動E2E。

- [ ] 7.1 シグナルハンドラの実装
  - 実装: Ctrl+C/システムシグナル捕捉、グレースフルシャットダウン開始、新規リクエスト拒否。
  - テストファースト: 要件4.2/4.3より、疑似シグナルを送ってレジストリがフリーズしない統合テストを先に作成。
  - 完了条件: シグナル統合テスト緑、手動でCtrl+C試験済み。

- [ ] 7.2 環境クリーンアップ処理
  - 実装: アクティブ環境一覧取得、コンテナ停止→削除、実行中コマンドのタイムアウト処理連携、ログ記録。
  - テストファースト: 要件4.2/4.3に従い、複数環境/実行中コマンドを含む統合テストを先に用意。
  - 完了条件: 統合テストと手動E2Eでクリーンアップ成功が確認できる。

- [ ] 8. 未実装機能のスタブ実装
  - 完了条件: 要件1.4に沿って、未実装メソッドが一律Unimplementedで返され、ログにTODOが残る。
  - テストカバレッジ: 各メソッドに対する統合テスト。

- [ ] 8.1 未実装メソッドハンドラの作成
  - 実装: watch-commit、note-append、up、downのスタブを配置し、TODOコメントを記載。
  - テストファースト: 要件1.4に基づき、各メソッド呼び出し時にUnimplementedとTODO文字列が返るテストを先に追加。
  - 完了条件: テスト緑、ログに将来実装予定のメッセージが残る。

- [ ] 9. テストの実装
  - 完了条件: 要件全体をカバーする自動/手動テストが揃い、CI/ローカルで再現可能。
  - テストカバレッジ: ユニット/統合/手動E2Eの全範囲が要件と対応付けられている。

- [ ] 9.1 ユニットテストの作成
  - 実装: 環境レジストリCRUD、リングバッファ、エラー変換、タイムアウトロジックのユニットテスト群。
  - テストファースト: 要件1〜6の個別要件を満たすケースをRed→Greenで整備。
  - 完了条件: cargo test --libが緑で、テストケースに要件IDコメントが付与されている。

- [ ] 9.2 統合テストの作成
  - 実装: MCPメッセージ送受信、環境ライフサイクル、エラー伝播、複数環境操作の統合テスト。
  - テストファースト: 要件1.1/2.1/3.1/4.2/5.3に対応するシナリオを先行実装。
  - 完了条件: cargo test --test integrationが緑、テストレポートに要件追跡表が出力。

- [ ] 9.3 手動E2Eテストスクリプトの作成
  - 実装: create_environment成功、echo hello、sleep 300タイムアウト、シャットダウンクリーンアップを自動化する手順書/スクリプト。
  - テストファースト: 要件全般の検証ステップを先に手順化し、実装後にスクリプト化して再実行。
  - 完了条件: 手順書に要件IDが紐付き、検証結果ログがリポジトリに保存される。

## 実装順序の推奨事項

1. タスク1-2（MCPサーバー & 環境管理）で基盤とデータ層をテスト駆動で構築
2. タスク3（Podmanクライアント）で外部依存をモック + 実機検証
3. タスク4（環境作成）で要件2/4を満たす統合テストを整備
4. タスク5（コマンド実行）で主要機能とリングバッファ/タイムアウトを実装
5. タスク6-7（エラー処理・クリーンアップ）で堅牢性を強化
6. タスク8-9（未実装スタブ・テスト群）で品質保証と回帰対策を完了

各タスクは先にテストケースを作成し、要件IDと紐づけたレポートを残すことで実装ブレを防ぎます。
