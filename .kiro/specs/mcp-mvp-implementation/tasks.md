# 実装計画

## 実装タスク一覧

- [ ] 1. MCPサーバー基盤の構築
- [ ] 1.1 MCPプロトコル処理の実装
  - stdio経由でJSONRPCメッセージを受信・処理する機能を実装
  - リクエストメッセージのバリデーションと適切なハンドラへのルーティング
  - レスポンスメッセージの生成と標準出力への送信
  - 無効なメッセージに対するエラーレスポンスの生成
  - _要件: 1.1, 1.2_

- [ ] 1.2 MCPメソッドハンドラの登録
  - create_environmentメソッドのハンドラ登録
  - run_commandメソッドのハンドラ登録
  - サポート外メソッドに対するUnimplementedエラーハンドラの登録
  - メソッドディスパッチャの実装
  - _要件: 1.1, 1.4_

- [ ] 2. 環境管理システムの実装
- [ ] 2.1 環境ハンドル構造の実装
  - 環境の識別情報と状態を保持するデータ構造の作成
  - コンテナID、プロジェクトパス、マウント情報の管理
  - 環境の作成時刻とステータス情報の追跡
  - _要件: 1.3, 2.6_

- [ ] 2.2 環境レジストリの実装
  - RwLockを使用した同時アクセス可能な環境管理マップの実装
  - 環境IDによる環境の登録・検索・削除機能
  - 同一環境IDの重複チェック機能
  - アクティブな環境の一覧取得機能
  - _要件: 1.3, 2.4, 4.1_

- [ ] 3. Podmanクライアントの実装
- [ ] 3.1 Podman API接続の確立
  - bollardを使用したPodman/Docker API接続の実装
  - Windows環境でのPodman serviceモードへの接続
  - Linux/macOS環境でのネイティブソケット接続
  - 接続エラー時の詳細なエラーメッセージ生成
  - _要件: 6.1, 6.4, 5.1_

- [ ] 3.2 コンテナイメージ管理
  - ローカルイメージの存在確認機能
  - レジストリからのイメージプル機能
  - プル進捗のストリーミング処理
  - イメージ関連エラーのハンドリング
  - _要件: 2.2_

- [ ] 3.3 コンテナライフサイクル管理
  - コンテナの作成と設定機能
  - ホストディレクトリのバインドマウント設定
  - 環境変数の設定機能
  - コンテナの起動・停止・削除機能
  - _要件: 2.1, 2.3, 2.5, 4.2_

- [ ] 4. 環境作成機能の実装
- [ ] 4.1 create_environmentハンドラの実装
  - リクエストパラメータの検証（project_root、env_id、image）
  - 環境IDの重複チェックとエラーレスポンス生成
  - イメージの準備とコンテナ作成の調整
  - 環境レジストリへの新規環境登録
  - _要件: 2.1, 2.4_

- [ ] 4.2 バインドマウントの設定
  - プロジェクトルートディレクトリの検証
  - /workdirへのバインドマウント設定
  - Windows環境でのパス形式変換処理
  - マウント失敗時の詳細エラー情報提供
  - _要件: 2.3_

- [ ] 4.4 Windows環境固有の処理
  - CRLF設定（core.autocrlf）の適切な処理
  - .gitattributes設定の考慮
  - プロセス管理メカニズムの実装（将来的なJob Object対応の基盤）
  - Windows固有のパス処理とエラーハンドリング
  - _要件: 6.2, 6.3_

- [ ] 4.3 環境作成レスポンスの生成
  - 環境ハンドル情報の収集（コンテナID、マウント先）
  - 成功レスポンスの構築と送信
  - 環境作成イベントのログ記録
  - _要件: 2.6, 5.3_

- [ ] 5. コマンド実行機能の実装
- [ ] 5.1 run_commandハンドラの実装
  - env_idによる対象環境の検索
  - コマンド配列とタイムアウト値の検証
  - 追加環境変数の処理
  - 存在しない環境に対するエラーハンドリング
  - _要件: 3.1, 3.5, 3.6_

- [ ] 5.2 コマンド実行とストリーミング処理
  - Podman exec経由でのコマンド実行
  - stdout/stderrの非同期ストリーミング処理
  - リアルタイムでの出力キャプチャ
  - 実行時間の計測
  - _要件: 3.1, 3.2_

- [ ] 5.3 リングバッファによる出力管理
  - 64KB制限のリングバッファ実装
  - stdout/stderrの個別バッファ管理
  - 最新出力の保持と古い出力の破棄
  - 出力テールの効率的な取得
  - _要件: 3.2, 4.4, 5.4_

- [ ] 5.4 タイムアウト処理の実装
  - タイムアウト値の適用（デフォルト120秒）
  - tokio::time::timeoutを使用したコマンド監視
  - タイムアウト時のプロセス強制終了
  - タイムアウト状態の記録とレスポンス生成
  - _要件: 3.3, 3.7, 4.3_

- [ ] 5.5 コマンド実行結果の返却
  - exit codeの収集
  - stdout/stderrテールの取得
  - 実行時間とタイムアウト情報の整形
  - 結果レスポンスの構築と送信
  - _要件: 3.4, 5.3_

- [ ] 6. エラーハンドリングとログ管理
- [ ] 6.1 エラー変換システムの実装
  - anyhowエラーからMCPエラーコードへの変換
  - ユーザーエラーとシステムエラーの分類
  - 詳細なエラーメッセージとヒントの生成
  - エラーコンテキストの保持と伝播
  - _要件: 5.2, 5.3_

- [ ] 6.2 ログシステムの構築
  - tracingフレームワークの初期化
  - 環境操作イベントの構造化ログ記録
  - コマンド実行の開始と終了の記録
  - エラー発生時の詳細コンテキスト記録
  - _要件: 5.3, 5.4_

- [ ] 6.3 並行アクセスの安全性確保
  - RwLockを使用した環境レジストリの保護
  - デッドロック防止のためのロック順序管理
  - 並行リクエストの適切な処理
  - リソース競合時のリトライ処理
  - _要件: 4.1, 5.5_

- [ ] 7. シャットダウンとクリーンアップ
- [ ] 7.1 シグナルハンドラの実装
  - Ctrl+Cシグナルの捕捉
  - システムシャットダウンシグナルの処理
  - グレースフルシャットダウンの開始
  - シャットダウン中の新規リクエスト拒否
  - _要件: 4.2, 4.3_

- [ ] 7.2 環境クリーンアップ処理
  - アクティブな環境の一覧取得
  - 各コンテナの順次停止処理
  - コンテナの削除と関連リソースの解放
  - クリーンアップ完了の確認とログ記録
  - _要件: 4.2, 4.3_

- [ ] 8. 未実装機能のスタブ実装
- [ ] 8.1 未実装メソッドハンドラの作成
  - watch-commit、note-append、up、downメソッドのスタブ
  - Unimplementedエラーコードの返却
  - 将来実装予定のメッセージ表示
  - TODOコメントの記載
  - _要件: 1.4_

- [ ] 9. テストの実装
- [ ] 9.1 ユニットテストの作成
  - 環境レジストリのCRUD操作テスト
  - リングバッファのオーバーフロー処理テスト
  - エラー変換ロジックのテスト
  - タイムアウト処理の動作確認テスト
  - _要件: 全般_

- [ ] 9.2 統合テストの作成
  - MCPメッセージの送受信テスト
  - 環境の作成から削除までのライフサイクルテスト
  - エラー伝播の確認テスト
  - 複数環境の同時操作テスト
  - _要件: 1.3, 4.1, 5.5_

- [ ] 9.3 手動E2Eテストスクリプトの作成
  - 環境作成の成功確認スクリプト
  - echo helloコマンドの実行確認
  - タイムアウト動作の確認（sleep 300）
  - シャットダウン時のクリーンアップ確認
  - _要件: 全般_

## 実装順序の推奨事項

1. タスク1-2（MCPサーバー基盤）を最初に実装し、基本的な通信を確立
2. タスク3（Podmanクライアント）で外部依存を解決
3. タスク2（環境管理）とタスク4（環境作成）で中核機能を構築
4. タスク5（コマンド実行）で主要機能を完成
5. タスク6-7（エラー処理とクリーンアップ）で堅牢性を確保
6. タスク8-9（スタブとテスト）で品質保証

各タスクは前のタスクの出力に依存しており、段階的に統合していく設計となっています。